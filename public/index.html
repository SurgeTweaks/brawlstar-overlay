<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Overlay Brawl Stars</title>
  <style>
    body {
      font-family: sans-serif;
      color: white;
      background: transparent;
    }

    #overlay {
      padding: 10px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      font-size: 20px;
    }
  </style>
</head>

<body>
  <div id="overlay">Chargement des stats...</div>

  <script>
    let playerTag = null;
    let encodedTag = null;
    let previousTrophies = null;
    let winstreak = 0;

    async function fetchPlayerTag() {
      const res = await fetch('/api/tag');
      const data = await res.json();
      playerTag = data.tag;
      encodedTag = encodeURIComponent(playerTag); // ✅ maintenant que playerTag est chargé
    }

    async function fetchStats() {
      if (!encodedTag) return;

      try {
        const res = await fetch(`/api/stats/${encodedTag}`);
        const data = await res.json();

        if (data.name) {
          const currentTrophies = data.trophies;
          let deltaText = '';

          if (previousTrophies !== null) {
            const delta = currentTrophies - previousTrophies;
            if (delta > 0) {
              winstreak += 1;
              deltaText = ` <span style="color:lightgreen;">(+${delta})</span>`;
            } else if (delta < 0) {
              winstreak = 0;
              deltaText = ` <span style="color:crimson;">(${delta})</span>`;
            } else {
              deltaText = ` <span style="color:gray;">(=)</span>`;
            }
          }

          previousTrophies = currentTrophies;

          document.getElementById('overlay').innerHTML = `
            <strong>${data.name}</strong><br>
            🏆 Trophées: ${currentTrophies}${deltaText}<br>
            🔥 Winstreak: ${winstreak}<br>
            🎖 Niveau: ${data.expLevel}<br>
            👥 Club: ${data.club?.name || 'Aucun'}
          `;
        } else {
          document.getElementById('overlay').innerText = "Erreur chargement stats";
        }
      } catch (err) {
        console.error("Erreur fetch:", err);
        document.getElementById('overlay').innerText = "Erreur de connexion";
      }
    }

    async function init() {
      await fetchPlayerTag();
      fetchStats();
      setInterval(fetchStats, 5000);
    }

    init();

  </script>

</body>

</html>