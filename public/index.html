<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Overlay Brawl Stars</title>
  <style>
    body {
      font-family: sans-serif;
      color: white;
      background: transparent;
    }

    #overlay {
      padding: 10px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      font-size: 20px;
    }

    .winstreak-reset {
      color: red;
      transition: color 0.5s ease;
    }
  </style>
</head>

<body>
  <div id="overlay">Chargement des stats...</div>

  <script>
    let playerTag = null;
    let encodedTag = null;
    let previousTrophies = null;

    // win streaks par tag
    const winstreakMap = {};

    // reset visuel après défaite
    let defeatFlashTimeout = null;

    async function fetchPlayerTag() {
      const res = await fetch('/api/tag');
      const data = await res.json();
      return data.tag;
    }

    async function fetchStats() {
      try {
        const newTag = await fetchPlayerTag();

        if (newTag !== playerTag) {
          playerTag = newTag;
          encodedTag = encodeURIComponent(playerTag);
          previousTrophies = null;
          if (!(playerTag in winstreakMap)) winstreakMap[playerTag] = 0;
          console.log(`🎯 Tag actif : ${playerTag}`);
        }

        const res = await fetch(`/api/stats/${encodedTag}`);
        const data = await res.json();

        if (data.name) {
          const currentTrophies = data.trophies;
          let deltaText = '';
          let winstreakText = '';
          let lost = false;

          if (previousTrophies !== null) {
            const delta = currentTrophies - previousTrophies;

            if (delta > 0) {
              winstreakMap[playerTag] += 1;
              deltaText = ` <span style="color:lightgreen;">(+${delta})</span>`;
            } else if (delta < 0) {
              winstreakMap[playerTag] = 0;
              lost = true;
              deltaText = ` <span style="color:crimson;">(${delta})</span>`;
            } else {
              deltaText = ` <span style="color:gray;">(=)</span>`;
            }
          }

          previousTrophies = currentTrophies;

          winstreakText = `<span id="winstreak" ${lost ? 'class="winstreak-reset"' : ''}>
            🔥 Winstreak: ${winstreakMap[playerTag]}
          </span>`;

          document.getElementById('overlay').innerHTML = `
            <strong>${data.name}</strong><br>
            🏆 Trophées: ${currentTrophies}${deltaText}<br>
            ${winstreakText}<br>
            🎖 Niveau: ${data.expLevel}<br>
            👥 Club: ${data.club?.name || 'Aucun'}
          `;

          // Retirer le rouge après 5 secondes
          if (lost && defeatFlashTimeout === null) {
            defeatFlashTimeout = setTimeout(() => {
              const el = document.getElementById('winstreak');
              if (el) el.classList.remove('winstreak-reset');
              defeatFlashTimeout = null;
            }, 5000);
          }

        } else {
          document.getElementById('overlay').innerText = "Erreur chargement stats";
        }
      } catch (err) {
        console.error("Erreur fetch:", err);
        document.getElementById('overlay').innerText = "Erreur de connexion";
      }
    }

    fetchStats();
    setInterval(fetchStats, 5000);
  </script>
</body>

</html>