<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Overlay Brawl Stars</title>
  <style>
    body {
      font-family: sans-serif;
      color: white;
      background: transparent;
    }

    #overlay {
      padding: 10px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      font-size: 20px;
    }

    .winstreak-reset {
      color: red;
      transition: color 0.5s ease;
    }
  </style>
</head>

<body>
  <div id="overlay">Chargement des stats...</div>

  <script>
    let playerTag = null;
    let encodedTag = null;
    let previousTrophies = null;
    let winstreakData = { current: 0, best: 0, lastTrophies: null };
    let defeatFlashTimeout = null;

    async function fetchPlayerTag() {
      const res = await fetch('/api/tag');
      const data = await res.json();
      return data.tag;
    }

    async function fetchWinstreak(tag) {
      const res = await fetch(`/api/winstreak/${encodeURIComponent(tag)}`);
      return await res.json();
    }

    async function saveTrophies(tag, trophies) {
      const res = await fetch(`/api/winstreak/${encodeURIComponent(tag)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newTrophies: trophies })
      });
      return await res.json();
    }

    async function fetchStats() {
      try {
        const newTag = await fetchPlayerTag();

        if (newTag !== playerTag) {
          playerTag = newTag;
          encodedTag = encodeURIComponent(playerTag);
          winstreakData = await fetchWinstreak(playerTag);
          previousTrophies = winstreakData.lastTrophies;
        }

        const res = await fetch(`/api/stats/${encodedTag}`);
        const data = await res.json();

        if (data.name) {
          const currentTrophies = data.trophies;
          let deltaText = '';
          let lost = false;

          if (previousTrophies !== null) {
            const delta = currentTrophies - previousTrophies;
            if (delta > 0) {
              deltaText = ` <span style="color:lightgreen;">(+${delta})</span>`;
            } else if (delta < 0) {
              deltaText = ` <span style="color:crimson;">(${delta})</span>`;
              lost = true;
            } else {
              deltaText = ` <span style="color:gray;">(=)</span>`;
            }
          }

          previousTrophies = currentTrophies;

          winstreakData = await saveTrophies(playerTag, currentTrophies);

          const bestDisplay = `ğŸ† Record: ${winstreakData.best}`;
          const streakDisplay = `<span id="winstreak" ${lost ? 'class="winstreak-reset"' : ''}>
            ğŸ”¥ Winstreak: ${winstreakData.current}
          </span>`;

          document.getElementById('overlay').innerHTML = `
            <strong>${data.name}</strong><br>
            ğŸ† TrophÃ©es: ${currentTrophies}${deltaText}<br>
            ${streakDisplay} / ${bestDisplay}<br>
            ğŸ– Niveau: ${data.expLevel}<br>
            ğŸ‘¥ Club: ${data.club?.name || 'Aucun'}
          `;

          if (lost && defeatFlashTimeout === null) {
            defeatFlashTimeout = setTimeout(() => {
              const el = document.getElementById('winstreak');
              if (el) el.classList.remove('winstreak-reset');
              defeatFlashTimeout = null;
            }, 5000);
          }

        } else {
          document.getElementById('overlay').innerText = "Erreur chargement stats";
        }
      } catch (err) {
        console.error("Erreur fetch:", err);
        document.getElementById('overlay').innerText = "Erreur de connexion";
      }
    }

    fetchStats();
    setInterval(fetchStats, 5000);
  </script>
</body>

</html>